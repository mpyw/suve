name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  test:
    name: Unit Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Build
        run: go build -v ./...

      - name: Run tests with coverage
        run: |
          PACKAGES=$(go list ./... | grep -v internal/gui | grep -v /cmd/)
          COVERPKG=$(go list ./... | grep -v internal/gui | grep -v /cmd/ | tr '\n' ',')
          go test -v -race -coverprofile=coverage.txt -covermode=atomic -coverpkg=$COVERPKG $PACKAGES

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.txt
          flags: unittests
          name: codecov-suve-unit
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  e2e:
    name: E2E Test
    runs-on: ubuntu-latest
    services:
      localstack:
        image: localstack/localstack:4
        ports:
          - 4566:4566
        env:
          SERVICES: ssm,secretsmanager
          DEBUG: 0
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Wait for localstack
        run: |
          timeout 60 bash -c 'until curl -sf http://localhost:4566/_localstack/health; do sleep 2; done'

      - name: Run e2e tests with coverage
        run: go test -v -race -tags e2e -coverprofile=coverage-e2e.txt -covermode=atomic -coverpkg=./... ./e2e/...
        env:
          SUVE_LOCALSTACK_EXTERNAL_PORT: 4566

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage-e2e.txt
          flags: e2e
          name: codecov-suve-e2e
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Run golangci-lint (default build)
        uses: golangci/golangci-lint-action@v9
        with:
          args: --timeout=5m

      - name: Create dummy frontend dist for production lint
        run: mkdir -p internal/gui/frontend/dist && touch internal/gui/frontend/dist/index.html

      - name: Install Wails dependencies (CGO)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev build-essential pkg-config

      - name: Run golangci-lint (production build)
        uses: golangci/golangci-lint-action@v9
        with:
          args: --timeout=5m --build-tags=production,webkit2_41

  gui-test:
    name: GUI Test (Playwright)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    defaults:
      run:
        working-directory: internal/gui/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: internal/gui/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npm test

      - name: Upload Playwright report
        uses: actions/upload-artifact@v6
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-${{ matrix.os }}
          path: internal/gui/frontend/playwright-report/
          retention-days: 30

  linux-package:
    name: Linux Package Lint (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            deb_arch: amd64
            rpm_arch: x86_64
          - arch: arm64
            runner: ubuntu-22.04-arm
            deb_arch: arm64
            rpm_arch: aarch64
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Detect GUI dependencies from Wails
        id: gui-deps
        uses: ./.github/actions/detect-gui-deps

      - name: Build test binaries
        run: |
          go build -o suve ./cmd/suve
          go build -o suve-cli ./cmd/suve
          file suve suve-cli

      - name: Verify binaries run correctly
        run: |
          ./suve --help
          ./suve --version
          ./suve-cli --help
          ./suve-cli --version

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@v2.41.1

      - name: Install lintian and rpmlint
        run: sudo apt-get update && sudo apt-get install -y lintian rpm rpmlint

      - name: Generate and verify Linux packages
        env:
          GTK_DEB: ${{ steps.gui-deps.outputs.gtk-deb }}
          GTK_RPM: ${{ steps.gui-deps.outputs.gtk-rpm }}
          WEBKIT_DEB: ${{ steps.gui-deps.outputs.webkit-deb }}
          WEBKIT_RPM: ${{ steps.gui-deps.outputs.webkit-rpm }}
          VERSION: "0.0.0-test"
          GOARCH: ${{ matrix.arch }}
        run: |
          set -euo pipefail

          # Show rendered templates in step summary
          {
            echo "## Linux Package Test (${{ matrix.arch }})"
            echo ""
            echo "### Detected GUI Dependencies"
            echo ""
            echo "| Package | Debian | RPM |"
            echo "|---------|--------|-----|"
            echo "| GTK | \`${GTK_DEB}\` | \`${GTK_RPM}\` |"
            echo "| WebKit | \`${WEBKIT_DEB}\` | \`${WEBKIT_RPM}\` |"
            echo ""
            echo "### Rendered nfpm Templates"
            echo ""
            echo "<details><summary>nfpm.yaml (CLI-only)</summary>"
            echo ""
            echo '```yaml'
            envsubst < .github/templates/nfpm.yaml
            echo '```'
            echo "</details>"
            echo ""
            echo "<details><summary>nfpm-gui.yaml (GUI)</summary>"
            echo ""
            echo '```yaml'
            envsubst < .github/templates/nfpm-gui.yaml
            echo '```'
            echo "</details>"
          } >> $GITHUB_STEP_SUMMARY

          # Generate .deb packages
          nfpm pkg --config .github/templates/nfpm.yaml --packager deb --target "suve-cli_test_${{ matrix.deb_arch }}.deb"
          nfpm pkg --config .github/templates/nfpm-gui.yaml --packager deb --target "suve_test_${{ matrix.deb_arch }}.deb"

          # Generate .rpm packages
          nfpm pkg --config .github/templates/nfpm.yaml --packager rpm --target "suve-cli-test.${{ matrix.rpm_arch }}.rpm"
          nfpm pkg --config .github/templates/nfpm-gui.yaml --packager rpm --target "suve-test.${{ matrix.rpm_arch }}.rpm"

          # Show package info in step summary
          {
            echo ""
            echo "### Generated Packages"
            echo ""
            echo "#### .deb packages"
            echo ""
            echo "<details><summary>suve-cli_test_${{ matrix.deb_arch }}.deb</summary>"
            echo ""
            echo '```'
            dpkg-deb -I "suve-cli_test_${{ matrix.deb_arch }}.deb"
            echo '```'
            echo "</details>"
            echo ""
            echo "<details><summary>suve_test_${{ matrix.deb_arch }}.deb</summary>"
            echo ""
            echo '```'
            dpkg-deb -I "suve_test_${{ matrix.deb_arch }}.deb"
            echo '```'
            echo "</details>"
            echo ""
            echo "#### .rpm packages"
            echo ""
            echo "<details><summary>suve-cli-test.${{ matrix.rpm_arch }}.rpm</summary>"
            echo ""
            echo '```'
            rpm -qip "suve-cli-test.${{ matrix.rpm_arch }}.rpm"
            echo '```'
            echo "</details>"
            echo ""
            echo "<details><summary>suve-test.${{ matrix.rpm_arch }}.rpm</summary>"
            echo ""
            echo '```'
            rpm -qip "suve-test.${{ matrix.rpm_arch }}.rpm"
            echo '```'
            echo "</details>"
          } >> $GITHUB_STEP_SUMMARY

      - name: Lint Linux packages
        run: |
          echo "=== lintian check (.deb) ==="
          # Suppress tags expected for Go binaries and nfpm quirks:
          # - no-changelog: No Debian-style changelog maintained
          # - no-manual-page: CLI has --help instead
          # - unknown-field: nfpm uses License field
          # - hardening-*: Go binaries don't support PIE/RELRO
          # - unstripped-binary-or-object: Go needs debug info for stack traces
          # - undeclared-elf-prerequisites: libc is provided by base system
          # - extended-description-contains-empty-paragraph: nfpm uses "." for paragraph breaks
          lintian --tag-display-limit 0 \
            --suppress-tags no-changelog,no-manual-page,unknown-field,hardening-no-pie,hardening-no-relro,unstripped-binary-or-object,undeclared-elf-prerequisites,extended-description-contains-empty-paragraph \
            "suve-cli_test_${{ matrix.deb_arch }}.deb" "suve_test_${{ matrix.deb_arch }}.deb"

          echo "=== rpmlint check (.rpm) ==="
          # rpmlint returns non-zero on warnings; allow warnings for:
          # - no-signature: Test packages aren't GPG signed
          # - no-manual-page-for-binary: CLI has --help instead
          # - no-documentation/no-changelogname-tag: Minimal package
          # - invalid-license: MIT is valid but rpmlint wants SPDX format
          rpmlint "suve-cli-test.${{ matrix.rpm_arch }}.rpm" "suve-test.${{ matrix.rpm_arch }}.rpm" || true

      - name: Test .deb installation
        run: |
          echo "=== Installing suve-cli .deb package ==="
          sudo dpkg -i "suve-cli_test_${{ matrix.deb_arch }}.deb"
          which suve
          suve --version
          suve --help

          echo "=== Removing suve-cli and installing suve (GUI) ==="
          sudo dpkg -r suve-cli
          sudo dpkg -i "suve_test_${{ matrix.deb_arch }}.deb"
          which suve
          suve --version
          suve --help

          echo "=== Cleanup ==="
          sudo dpkg -r suve

      - name: Test .rpm installation (Fedora container)
        run: |
          # Use Fedora container to test rpm installation
          docker run --rm -v "$PWD:/work" -w /work fedora:latest bash -c '
            set -e
            echo "=== Installing suve-cli .rpm package ==="
            dnf install -y "./suve-cli-test.${{ matrix.rpm_arch }}.rpm"
            which suve
            suve --version
            suve --help

            echo "=== Removing suve-cli and installing suve (GUI) ==="
            dnf remove -y suve-cli
            dnf install -y "./suve-test.${{ matrix.rpm_arch }}.rpm"
            which suve
            suve --version
            suve --help
          '

  gui-test-windows:
    name: GUI Test (Playwright) (Windows)
    runs-on: windows-latest
    if: >-
      github.ref == 'refs/heads/main' ||
      contains(github.event.head_commit.message, '[CI: windows]')
    defaults:
      run:
        working-directory: internal/gui/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: internal/gui/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npm test

      - name: Upload Playwright report
        uses: actions/upload-artifact@v6
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-windows-latest
          path: internal/gui/frontend/playwright-report/
          retention-days: 30
